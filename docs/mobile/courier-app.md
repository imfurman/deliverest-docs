# Курьерское приложение

Мобильное приложение курьера входит в состав Deliverest и поставляется в исходниках (`deliverest_courier_app_source/deliverycourier`). Оно работает поверх API `Superdostavka\ApiBundle\Controller\CourierApi` и предназначено для Android-устройств. Ниже — практическое руководство для менеджеров службы доставки: как настроить приложение, какие функции доступны курьерам и какие параметры можно менять без разработчиков.

## Установка и доступ

1. **Учётная запись**. Создайте сотрудника с ролью курьера в разделе [Пользователи и роли](../staff/users.md). При необходимости включите SMS-подтверждение.
2. **Домейн**. При первом входе курьер вводит адрес вашей службы (например, `https://brand.deliverest.io`). Приложение сохраняет базовый URL (ключ `URL` в `StorageDao`) и использует его при последующих авторизациях.
3. **Токены и защита**. После авторизации курьер получает доступный токен (`ACCESS_TOKEN`). Менеджер может в любой момент сбросить токен — приложение запросит повторный вход.

## Интерфейс и сценарии работы

### Список заказов

- Курьер видит активные заказы, сгруппированные по времени и типу доставки (экспресс/обычная).
- Каждая карточка содержит:
  - адрес и подъездную информацию;
  - контакт клиента с кнопкой звонка;
  - знак оплаты и сумму;
  - кнопку изменения статуса (показывается, если статус разрешён на текущем этапе).
- Свайпом вниз можно обновить список; при отсутствии интернета приложение показывает соответствующее сообщение.

### Маршруты и навигация

- Нажатие на заголовок заказа открывает маршрут. Курьер может выбрать сервис навигации (Яндекс, Google или 2ГИС) — выбранный тип хранится в настройках пользователя (`MapType`).
- Встроенная карта не привязана к конкретному провайдеру, поэтому легко адаптируется к региону.

### Связь с оператором и клиентом

- Прямой звонок клиенту доступен из карточки заказа.
- Через панель уведомлений оператор может прислать push с уточнениями; уведомление открывает заказ в приложении.

### Отметка статусов

- Кнопка «Изменить статус» обновляет состояние заказа (например, «Принял на кухне», «В пути», «Доставлено»). Доступность и текст кнопки задаются на сервере.
- Цвет текущего статуса подтягивается из конфигурации (см. «Настройка и брендирование»).

## Фоновая работа и геолокация

### Отправка координат

- Приложение запускает сервис `LocationUpdateService`, который передаёт координаты курьера по заданному интервалу (`update_coordinates_time` в настройках).
- Сервис работает в foreground-режиме: в шторке Android показывается уведомление «Передача координат».
- Если устройство перезагрузилось, `BootReceiver` автоматически перезапустит сервис (при условии, что он был включён).

### Push-уведомления

- `FirebasePushService` получает уведомления от Deliverest и:
  - обновляет список заказов без действий с боку курьера;
  - показывает системное уведомление с заголовком и текстом.
- Менеджеры могут настраивать, какие события (новый заказ, изменение статуса) отправляются курьеру через раздел [Уведомления](../automation/notifications.md).

### Оффлайн-режим

- Основная конфигурация приложения (цвета, логотипы, интервалы обновления) хранится локально в базе Room (`ConfigurationDao`). Это позволяет запускаться даже при отсутствии интернета.
- Токен и настройки карты сохраняются в SharedPreferences, поэтому курьер не повторяет вход после кратковременной потери сети.

## Настройка и брендирование

Deliverest автоматически передаёт в приложение параметры из конфигурации сервера:

- `header_color` — цвет шапки и основных элементов интерфейса.
- `logo_url` и `splash_logo_url` — логотип и splash-экран.
- `status_colors` — палитра статусов (используется в карточках заказов).
- `locale` — язык интерфейса; приложение поддерживает локализацию на русском и английском.

Чтобы обновить оформление:

1. Зайдите в «Настройки → Конфигурация сайта».
2. Обновите логотипы, цвета и интервал обновления координат.
3. Перезапустите приложение на устройстве — новые параметры подтянутся при следующем запросе конфигурации.

## Советы по эксплуатации

- **Учите курьеров** включать GPS и держать приложение в фоне. Если Android ограничивает работу в фоне, добавьте Deliverest в список исключений от энергосбережения.
- **Проверяйте push** после каждого обновления — пришлите тестовое сообщение через MasterBot или панель рассылок.
- **Следите за версиями**. Исходный код находится в `deliverest_courier_app_source`. При необходимости кастомизации (например, интеграции с корпоративной MDM-системой) передайте его вашим разработчикам.
- **Используйте отчёты**. В разделе «[Производство и склад](../production/index.md)» и «[Отчёты](../reports/index.md)» вы увидите, как курьеры соблюдают SLA, и сможете корректировать графики.

Курьерское приложение — ключевой инструмент быстрой доставки. Регулярно обновляйте конфигурацию и обучайте курьеров, чтобы клиенты всегда получали заказы вовремя и с нужной обратной связью.
