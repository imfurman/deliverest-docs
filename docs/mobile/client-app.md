# Клиентское приложение

Deliverest поставляет собственное мобильное приложение для клиентов (Android/iOS). Исходный код лежит в `deliverest_client_app_source/appcomponents` — это Flutter-проект с модулями для каталога, корзины, оформления заказа, бонусной программы и личного кабинета. Ниже — руководство, которое поможет быстро настраивать приложение под ваш бренд и эффективно использовать встроенные функции.

## Архитектура и источники данных

- **Экран меню (MenuScreen)** подгружает каталог и баннеры напрямую из Deliverest. Разделы, подарки, рекомендации и pickup-модули отображаются автоматически при включении в админке.
- **Корзина (CartScreen)** использует общую бизнес-логику: промокоды, подарочные позиции, несовместимые скидки, количество персон. Все проверки выполняются на стороне сервера — клиент обновляет корзину, как только в админке меняются акции.
- **Оформление заказа (CreateOrderService)** валидирует заказ перед отправкой, поддерживает оплату наличными, картой курьеру и онлайн (URL-оплата открывается во встроенном webview). После завершения корзина очищается и пользователь видит экран «Спасибо».
- **Активный заказ и история** обновляются через `ActiveOrderService`: клиент видит статус, может оплатить заказ курьеру ещё раз или отменить его, если служба разрешает.
- **Push и аналитика**: приложение подключено к AppMetrica и Firebase. Push-уведомления используют канал `superdostavka.com.delivery.orders`, а кастомные события отправляются при важных действиях (добавление в корзину, оформление заказа).

## Брендирование и многофранчайзность

В каталоге исходников вы найдёте десятки конфигураций `flutter_native_splash-*.yaml`, `client_ids_to_build.yaml`, `projects/`. Deliverest поддерживает сборку под разные бренды без изменений кода:

- Цвета, логотипы, шрифты, заставки и иконки приходят из сервера (`ConfigService`). Параметры задаются в админке в разделе «Настройки → Конфигурация сайта».
- Splash и иконки для конкретного клиента описываются в YAML-файлах; при сборке выбирается нужный профиль. Используйте Makefile или скрипты `rb.sh` для выпуска (описаны в `instructions.txt`).
- Темing (тема приложения) автоматически подстраивается под цветовую схему бренда (в том числе цвета статусов, бонусов, кнопок).

## Основные сценарии для клиента

| Сценарий | Что видит пользователь | Настраиваемые элементы |
|----------|------------------------|-----------------------|
| Просмотр меню | Баннеры, подборки, подарок за заказ, pickup-модуль, меню по разделам | Баннеры (Маркетинг → Продвижение в приложении), подарки (Маркетинг → Подарочные позиции), pickup (Настройки → Конфигурация сайта) |
| Работа с корзиной | Редактирование позиций, добавочные товары, предупреждения о несовместимых скидках, применение бонусов/промокода | Акции, подарки, промокоды, лимиты используются из админки |
| Оформление | Выбор адреса, времени, способа оплаты, комментарий, опция «не звонить» | Включается/выключается в «Настройки → Конфигурация сайта» и «Настройки → Интеграции» |
| Отслеживание доставки | Экран активного заказа, таймер готовности, статус, кнопки оплаты, карта | Статусы и цвета приходят из сервера; карта зависит от подключенных сервисов |
| Личный кабинет | История заказов, бонусы, сохранённые адреса, уведомления | Настраивается в админке (программа лояльности, уведомления, WebView для правил) |

## Варианты авторизации

Приложение поддерживает несколько методов авторизации (включаются из админки):

- SMS-код на телефон.
- Обратный звонок (робот диктует код).
- Telegram OAuth (при активации клиенты переходят в бот и подтверждают аккаунт).

Вход требует акцепта оферты. Ссылки на документы подставляются автоматически (адрес берётся из `AppConfig.apiUri`).

## Локализация и персонализация

- Язык UI определяется полем `locale` в конфигурации (поддерживаются минимум русский и английский). Можно включать дополнительный язык для конкретной сети.
- Каталог, баннеры, pickup и подарки отображаются в зависимости от города. При смене города приложение автоматически подгружает соответствующее меню.
- Промокоды, бонусы и подарки отображаются в корзине и на главной, если включены в маркетинговых настройках.
- Для сетей-агрегаторов можно включить режим выбора бренда/города: приложение стартует с экрана выбора города (`isAggregator = true`) и подгружает индивидуальное меню.

## Профиль и аккаунт клиента

- Экран профиля показывает имя и телефон, позволяет быстро выйти из аккаунта или удалить его (опция доступна в агрегаторном режиме).  
- Сохранённые адреса, карты и предпочтения подгружаются из Deliverest — оператор всегда видит актуальные данные.
- При смене устройства клиенту достаточно заново авторизоваться: история заказов, бонусы и адреса подтянутся автоматически.

## Бонусы, подарки и промокоды

- Страница «Бонусная система» отображает текущий баланс, процент кешбэка на месяц, историю операций и условия следующего уровня.
- Модуль «Подарок за N заказов» визуализирует прогресс: клиенты видят, сколько заказов осталось до подарка, описание акции и подробности (источник — раздел Маркетинга).
- Промокоды и подарки автоматически применяются в корзине, если условия выполнены. Несовместимые акции подсвечиваются в интерфейсе.

## Pickup, доставка и карты

- Pickup-модуль позволяет клиенту выбрать точку самовывоза. Режим включается в конфигурации (параметр `pickupModule`).
- При отсутствии зон доставки для адреса приложение предлагает самовывоз или показывает сообщение со ссылкой на правила доставки.
- Для навигации доступны разные карты (Яндекс, Google, 2ГИС). Клиент может выбрать предпочитаемый сервис; выбор сохраняется в настройках.

## Офлайн-статички и webview

- Встроенные webview (`DrawerWebView`) используются для страницы «Доставка и оплата», «Политика конфиденциальности» и онлайн-оплаты. URL берутся из админки — менять тексты можно без разработки.
- Если страница временно недоступна, приложение уведомит клиента и предложит повторить попытку.

## Уведомления и активный заказ

- Приложение подписывается на push-события и обновляет ленту заказов без участия пользователя.
- Активный заказ отслеживается в реальном времени. Если статус «Не оплачен», приложение показывает диалог с предложением оплатить повторно или сменить способ.
- История заказов обновляется каждые 2 минуты для заказов в статусе «В пути»/«Готовится», чтобы клиенты видели прогресс.

## Онлайн-оплата и повторная покупка

- Онлайн-оплата открывается в вебвью; при успехе заказ автоматически закрывается, корзина очищается и клиент видит благодарность.
- При возврате на меню приложение сохраняет адрес и способы оплаты, что ускоряет повторный заказ.
- Приложение интегрировано с AppMetrica: данные по заказам уходят в аналитик и помогают считать конверсии.

## Сборка и обновления

- Проект написан на Flutter. Для каждой сети предусмотрены отдельные конфигурации (шаблоны в каталоге `projects/`, настройки splash-экранов и иконок — `flutter_native_splash-*.yaml`).
- Сборка под конкретного клиента выполняется командами из Makefile или скриптов `rb.sh` (см. `instructions.txt`).  
- Перед релизом проверьте:
  - доступность API и корректность URL в `ConfigService`;
  - настройки push (Firebase, AppMetrica);
  - список доступных методов оплаты и авторизации.

## Советы по эксплуатации

- **Проверяйте конфигурацию перед релизом**: логотип, цвета, тексты уведомлений, интервалы работы. Изменения в админке подтягиваются при первом запуске приложения.
- **Используйте A/B-тесты** в маркетинге: отображайте разные баннеры и подарки, отслеживайте конверсию через AppMetrica и отчёты Deliverest.
- **Обновляйте сборки централизованно**: исходники в `deliverest_client_app_source` позволяют быстро пересобрать приложение для нового бренда или сети.
- **Обучайте поддержку**: кнопка «Не звонить» и комментарии к заказу снижают нагрузку на операторов; подсказывайте клиентам, как использовать push, карту и повторные заказы.
- **Следите за отзывами**: в разделе «Клиенты → Обратная связь» смотрите, какие функции клиенты запрашивают чаще всего, и обновляйте приложение в соответствии с ожиданиями.

Клиентское приложение — цифровое меню вашего бренда. Поддерживайте его актуальность через админку Deliverest, планируйте релизы в Flutter-проекте и сочетайте с CRM/маркетингом — так вы получите максимальную отдачу от мобильного канала.
